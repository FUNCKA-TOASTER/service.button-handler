import random
from toaster.broker.events import Event
from toaster.keyboards import Keyboard, ButtonColor, Callback
from data import TOASTER_DB
from data import UserPermission
from data.scripts import (
    get_peer_mark,
    set_peer_mark,
    drop_peer_mark,
    update_peer_data,
    get_user_permission,
    set_user_permission,
    drop_user_permission,
)
from .base import BaseAction


# ------------------------------------------------------------------------
class Error(BaseAction):
    NAME = "error"

    def _handle(self, event: Event) -> bool:
        snackbar_message = "‚ö†Ô∏è –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫."
        self.snackbar(event, snackbar_message)

        return False


class RejectAccess(BaseAction):
    NAME = "reject_access"

    def _handle(self, event: Event) -> bool:
        snackbar_message = "‚ö†Ô∏è –û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ."
        self.snackbar(event, snackbar_message)

        return False


class CloseMenu(BaseAction):
    NAME = "close_menu"

    def _handle(self, event: Event) -> bool:
        self.api.messages.delete(
            peer_id=event.peer.bpid,
            cmids=event.button.cmid,
            delete_for_all=1,
        )

        snackbar_message = "‚ùå –ú–µ–Ω—é –∑–∞–∫—Ä—ã—Ç–æ."
        self.snackbar(event, snackbar_message)

        # TODO: –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –º–µ–Ω—é –∏–∑ –ë–î

        return True


# ------------------------------------------------------------------------
class SetMark(BaseAction):
    NAME = "set_mark"

    def _handle(self, event: Event) -> bool:
        mark = get_peer_mark(
            db_instance=TOASTER_DB,
            bpid=event.peer.bpid,
        )

        if mark is None:
            payload = event.button.payload
            mark = payload.get("mark")

            set_peer_mark(
                db_instance=TOASTER_DB,
                mark=mark,
                bpid=event.peer.bpid,
                bpn=event.peer.name,
            )
            snackbar_message = f'üìù –ë–µ—Å–µ–¥–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ "{mark}".'

        else:
            snackbar_message = f'‚ùó–ë–µ—Å–µ–¥–∞ —É–∂–µ –∏–º–µ–µ—Ç –º–µ—Ç–∫—É "{mark}".'

        self.snackbar(event, snackbar_message)

        return True


class UpdatePeerData(BaseAction):
    NAME = "update_peer_data"

    def _handle(self, event: Event) -> bool:
        mark = get_peer_mark(
            db_instance=TOASTER_DB,
            bpid=event.peer.bpid,
        )

        if mark is not None:
            update_peer_data(
                db_instance=TOASTER_DB,
                bpid=event.peer.bpid,
                name=event.peer.name,
            )
            snackbar_message = "üìù –î–∞–Ω–Ω—ã–µ –±–µ—Å–µ–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã."

        else:
            snackbar_message = "‚ùó–ë–µ—Å–µ–¥–∞ –µ—â–µ –Ω–µ –∏–º–µ–µ—Ç –º–µ—Ç–∫—É."

        self.snackbar(event, snackbar_message)

        return True


class DropMark(BaseAction):
    NAME = "drop_mark"

    def _handle(self, event: Event) -> bool:
        mark = get_peer_mark(
            db_instance=TOASTER_DB,
            bpid=event.peer.bpid,
        )

        if mark is not None:
            drop_peer_mark(
                db_instance=TOASTER_DB,
                bpid=event.peer.bpid,
            )
            snackbar_message = f'üìù –ú–µ—Ç–∫–∞ "{mark}" —Å–Ω—è—Ç–∞ —Å –±–µ—Å–µ–¥—ã.'

        else:
            snackbar_message = "‚ùó–ë–µ—Å–µ–¥–∞ –µ—â–µ –Ω–µ –∏–º–µ–µ—Ç –º–µ—Ç–∫—É."

        self.snackbar(event, snackbar_message)

        return True


# ------------------------------------------------------------------------
class SetPermission(BaseAction):
    NAME = "set_permission"

    def _handle(self, event: Event) -> bool:
        payload = event.button.payload
        target_uuid = payload.get("target")

        current_permission = get_user_permission(
            db_instance=TOASTER_DB,
            uuid=target_uuid,
            bpid=event.peer.bpid,
        )

        new_permission = int(payload.get("permission"))
        role = UserPermission(current_permission)

        if current_permission == 0:
            role = UserPermission(new_permission)
            set_user_permission(
                db_instance=TOASTER_DB,
                uuid=target_uuid,
                bpid=event.peer.bpid,
                lvl=new_permission,
            )
            snackbar_message = f'‚öíÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ä–æ–ª—å "{role.name}".'
            self.snackbar(event, snackbar_message)
            return True

        else:
            role = UserPermission(current_permission)
            snackbar_message = f'‚ùó–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∏–º–µ–µ—Ç —Ä–æ–ª—å "{role.name}".'
            self.snackbar(event, snackbar_message)
            return False


class DropPermission(BaseAction):
    NAME = "drop_permission"

    def _handle(self, event: Event) -> bool:
        payload = event.button.payload
        target_uuid = payload.get("target")

        current_permission = get_user_permission(
            db_instance=TOASTER_DB,
            uuid=target_uuid,
            bpid=event.peer.bpid,
            ignore_staff=True,
        )

        if current_permission > 0:
            drop_user_permission(
                db_instance=TOASTER_DB,
                uuid=target_uuid,
                bpid=event.peer.bpid,
            )
            snackbar_message = "‚öíÔ∏è –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–±—Ä–æ—à–µ–Ω–∞."
            self.snackbar(event, snackbar_message)
            return True

        else:
            snackbar_message = "‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç —Ä–æ–ª–∏."
            self.snackbar(event, snackbar_message)
            return False


# ------------------------------------------------------------------------
class GameRoll(BaseAction):
    NAME = "game_roll"
    EMOJI = ["0Ô∏è‚É£", "1Ô∏è‚É£", " 2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£"]

    def _handle(self, event: Event) -> bool:
        num = random.randint(0, 100)
        result = ""
        for didgit in str(num):
            result += self.EMOJI[int(didgit)]

        tag = f"[id{event.user.uuid}|{event.user.name}]"
        new_msg_text = f"{tag} –≤—ã–±–∏–≤–∞–µ—Ç —á–∏—Å–ª–æ: {result}"

        keyboard = (
            Keyboard(inline=True, one_time=False, owner_id=event.user.uuid)
            .add_row()
            .add_button(
                Callback(label="–°–∫—Ä—ã—Ç—å", payload={"action_name": "close_menu"}),
                ButtonColor.SECONDARY,
            )
        )

        self.api.messages.edit(
            peer_id=event.peer.bpid,
            conversation_message_id=event.button.cmid,
            message=new_msg_text,
            keyboard=keyboard.json,
        )

        snackbar_message = "üé≤ –†—É–ª–µ—Ç–∫–∞ –ø—Ä–æ–∫—Ä—É—á–µ–Ω–∞!"
        self.snackbar(event, snackbar_message)

        # TODO: –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é –º–µ–Ω—é

        return True


class GameCoinflip(BaseAction):
    NAME = "game_coinflip"
    EMOJI = ["–û—Ä—ë–ª ü™ô", "–†–µ—à–∫–∞ ü™ô"]

    def _handle(self, event: Event) -> bool:
        num = random.randint(0, 1)
        result = self.EMOJI[num]

        tag = f"[id{event.user.uuid}|{event.user.name}]"
        new_msg_text = f"{tag} –ø–æ–¥–±—Ä–∞—Å—ã–≤–∞–µ—Ç –º–æ–Ω–µ—Ç–∫—É: {result}"

        keyboard = (
            Keyboard(inline=True, one_time=False, owner_id=event.user.uuid)
            .add_row()
            .add_button(
                Callback(label="–°–∫—Ä—ã—Ç—å", payload={"action_name": "close_menu"}),
                ButtonColor.SECONDARY,
            )
        )

        self.api.messages.edit(
            peer_id=event.peer.bpid,
            conversation_message_id=event.button.cmid,
            message=new_msg_text,
            keyboard=keyboard.json,
        )

        snackbar_message = "üé≤ –ú–æ–Ω–µ—Ç–∞ –±—Ä–æ—à–µ–Ω–∞!"
        self.snackbar(event, snackbar_message)

        # TODO: –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é –º–µ–Ω—é

        return True


# ------------------------------------------------------------------------
